#CRAWL DATA WEB VIETSTOCK
import re
import time
import math
import random
from datetime import datetime
from typing import List, Dict, Set, Tuple

import pandas as pd
from bs4 import BeautifulSoup

from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.chrome.service import Service


# 3 trang bảng giá theo sàn
EXCHANGE_URL = {
    "HOSE":  "https://banggia.vietstock.vn/bang-gia/hose",
    "HNX":   "https://banggia.vietstock.vn/bang-gia/hnx",
    "UPCOM": "https://banggia.vietstock.vn/bang-gia/upcom",
}

# Lấy mã chuẩn (tránh BAFBAF)
CODE_RE = re.compile(r"\b[A-Z0-9]{1,6}\b")


def make_driver(headless: bool = True) -> webdriver.Chrome:
    opt = Options()
    if headless:
        opt.add_argument("--headless=new")
    opt.add_argument("--window-size=1400,900")
    opt.add_argument("--disable-gpu")
    opt.add_argument("--no-sandbox")
    opt.add_argument("--disable-dev-shm-usage")
    opt.add_argument("--lang=vi-VN")
    opt.add_argument(
        "user-agent=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) "
        "AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
    )

    service = Service(ChromeDriverManager().install())
    driver = webdriver.Chrome(service=service, options=opt)
    driver.set_page_load_timeout(60)
    return driver


def _parse_symbols_from_html(html: str) -> List[str]:
    """Parse list symbol từ cột đầu tiên của bảng (Mã CK)."""
    soup = BeautifulSoup(html, "html.parser")
    out = []
    for tr in soup.select("table tbody tr"):
        tds = tr.find_all("td")
        if not tds:
            continue
        raw = tds[0].get_text(" ", strip=True)
        m = CODE_RE.search(raw)
        if not m:
            continue
        out.append(m.group(0).upper())
    return out


def _try_click_next(driver: webdriver.Chrome) -> bool:
    """
    Thử click nút Next (DataTables). True nếu click được, False nếu không có/disabled.
    """
    selectors = [
        "a.next",
        ".dataTables_paginate a.next",
        "li.paginate_button.next a",
        "a#banggia_next",
    ]

    for sel in selectors:
        els = driver.find_elements(By.CSS_SELECTOR, sel)
        if not els:
            continue
        a = els[0]

        # disabled thường nằm ở class của a hoặc parent li
        a_cls = a.get_attribute("class") or ""
        parent_cls = ""
        try:
            parent_cls = a.find_element(By.XPATH, "..").get_attribute("class") or ""
        except Exception:
            pass

        if "disabled" in (a_cls + " " + parent_cls):
            return False

        try:
            driver.execute_script("arguments[0].click();", a)
            time.sleep(random.uniform(0.7, 1.1))
